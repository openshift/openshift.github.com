<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  File: README.writing_cartridges
  
    &mdash; Documentation by YARD 0.8.5.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README.writing_cartridges</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><div id='filecontents'><h1>How To Write An OpenShift Origin Cartridge 2.0</h1>

<p>OpenShift cartridges provide the necessary command and control for
the functionality of software that is running user&#39;s applications.
OpenShift currently has many language cartridges JBoss, PHP, Ruby
(Rails) etc. as well as many DB cartridges such as Postgres, Mysql,
Mongo etc. Before writing your own cartridge you should search the
current list of <a href="https://openshift.redhat.com">Red Hat</a> and <a href="https://openshift.redhat.com/community">OpenShift
Community</a> provided cartridges.</p>

<p>Cartridge configuration and setup is convention based, with an emphasis
on minimizing external dependencies in your cartridge code.</p>

<h2>Cartridge Directory Structure</h2>

<p>This is an example structure to which your cartridge is expected to
conform when written to disk. Failure to meet these expectations will
cause your cartridge to not function when either installed or used on
OpenShift. You may have additional directories or files as required to meet
the needs of the software you are packaging and the application developers
using your cartridge.</p>

<pre class="code ruby"><code class="ruby"><span class='xstring val'>`vendor name`</span><span class='minus op'>-</span><span class='xstring val'>`cartridge name`</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_bin identifier id'>bin</span>                        <span class='lparen token'>(</span><span class='rubyid_required identifier id'>required</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_setup identifier id'>setup</span>                   <span class='lparen token'>(</span><span class='rubyid_required identifier id'>required</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_teardown identifier id'>teardown</span>                <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_control identifier id'>control</span>                 <span class='lparen token'>(</span><span class='rubyid_required identifier id'>required</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span><span class='minus op'>-</span> <span class='rubyid_hooks identifier id'>hooks</span>                      <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_set identifier id'>set</span><span class='minus op'>-</span><span class='rubyid_db identifier id'>db</span><span class='minus op'>-</span><span class='rubyid_connection identifier id'>connection</span><span class='minus op'>-</span><span class='rubyid_info identifier id'>info</span>  <span class='lparen token'>(</span><span class='rubyid_discretionary identifier id'>discretionary</span><span class='rparen token'>)</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_versions identifier id'>versions</span>                   <span class='lparen token'>(</span><span class='rubyid_discretionary identifier id'>discretionary</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='xstring val'>`software version`</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_bin identifier id'>bin</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>     <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_data identifier id'>data</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>     <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_template identifier id'>template</span>          <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>        <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot token'>.</span><span class='rubyid_openshift identifier id'>openshift</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>        <span class='bitor op'>|</span>   <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>        <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span> <span class='lparen token'>(</span><span class='rubyid_directory identifier id'>directory</span><span class='div op'>/</span><span class='rubyid_file identifier id'>file</span> <span class='rubyid_tree identifier id'>tree</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>     <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_template identifier id'>template</span><span class='dot token'>.</span><span class='rubyid_git identifier id'>git</span>       <span class='lparen token'>(</span><span class='rubyid_discretionary identifier id'>discretionary</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='bitor op'>|</span>        <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span> <span class='lparen token'>(</span><span class='rubyid_git identifier id'>git</span> <span class='rubyid_bare identifier id'>bare</span> <span class='rubyid_repo identifier id'>repo</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_env identifier id'>env</span>                        <span class='lparen token'>(</span><span class='rubyid_required identifier id'>required</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='mult op'>*</span><span class='dot token'>.</span><span class='rubyid_erb identifier id'>erb</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_template identifier id'>template</span>                   <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span> <span class='lparen token'>(</span><span class='rubyid_directory identifier id'>directory</span><span class='div op'>/</span><span class='rubyid_file identifier id'>file</span> <span class='rubyid_tree identifier id'>tree</span><span class='rparen token'>)</span>
 <span class='plus op'>+</span>  <span class='rubyid_template identifier id'>template</span><span class='dot token'>.</span><span class='rubyid_git identifier id'>git</span>               <span class='lparen token'>(</span><span class='rubyid_discretionary identifier id'>discretionary</span><span class='rparen token'>)</span>
 <span class='plus op'>+</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span> <span class='lparen token'>(</span><span class='rubyid_bare identifier id'>bare</span> <span class='rubyid_git identifier id'>git</span> <span class='rubyid_repository identifier id'>repository</span><span class='rparen token'>)</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_usr identifier id'>usr</span>                        <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot3 op'>...</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_metadata identifier id'>metadata</span>                   <span class='lparen token'>(</span><span class='rubyid_required identifier id'>required</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_manifest identifier id'>manifest</span><span class='dot token'>.</span><span class='rubyid_yml identifier id'>yml</span>            <span class='lparen token'>(</span><span class='rubyid_required identifier id'>required</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_locked_files identifier id'>locked_files</span><span class='dot token'>.</span><span class='rubyid_txt identifier id'>txt</span>        <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_snapshot_exclusions identifier id'>snapshot_exclusions</span><span class='dot token'>.</span><span class='rubyid_txt identifier id'>txt</span> <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_restore_transforms identifier id'>restore_transforms</span><span class='dot token'>.</span><span class='rubyid_txt identifier id'>txt</span>  <span class='lparen token'>(</span><span class='rubyid_optional identifier id'>optional</span><span class='rparen token'>)</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_conf identifier id'>conf</span><span class='dot token'>.</span><span class='rubyid_d identifier id'>d</span>                     <span class='lparen token'>(</span><span class='rubyid_discretionary identifier id'>discretionary</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_openshift identifier id'>openshift</span><span class='dot token'>.</span><span class='rubyid_conf identifier id'>conf</span><span class='dot token'>.</span><span class='rubyid_erb identifier id'>erb</span>
 <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_conf identifier id'>conf</span>                       <span class='lparen token'>(</span><span class='rubyid_discretionary identifier id'>discretionary</span><span class='rparen token'>)</span>
 <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_magic identifier id'>magic</span>
</code></pre>

<p>Items marked:
  * <code>required</code> must exist for minimal OpenShift support of your cartridge
  * <code>optional</code> exist to support additional functionality
  * <code>discretionary</code> should be considered best practices for your cartridge and work. E.g.,
    <code>conf.d</code> is the usual name for where a web framework would install it&#39;s <code>httpd</code> configuration.</p>

<p>To support multiple software versions within one cartridge,
you may create symlinks between the bin/control and the setup
versions/version/bin/control file. Or, you may choose
to use the bin/control file as a shim to call the correct versioned
control file.</p>

<p>When creating an instance of your cartridge for use by a gear, OpenShift
will copy the files, links and directories from the cartridge library
with the exclusion of the <code>usr</code> directory. The <code>usr</code> directory will be
sym-linked into the gear&#39;s cartridge instance. This allows for sharing
of libraries and other data across all cartridge instances.</p>

<p>Later (see Cartridge Locking) we&#39;ll describe how, as the cartridge author,
you can customize a cartridge instance.</p>

<h2>Cartridge Metadata</h2>

<p>The <code>manifest.yml</code> file is used by OpenShift to determine what features
your cartridge requires and in turn publishes. OpenShift also uses fields
in the <code>manifest.yml</code> to determine what data to present to the cartridge
user about your cartridge.</p>

<p>An example <code>manifest.yml</code> file:</p>

<pre class="code yaml"><code class="yaml">Name: PHP
Cartridge-Short-Name: PHP
Cartridge-Version: '1.0.1'
Cartridge-Versions: [1.0.1]
Cartridge-Vendor: Red Hat
Display-Name: PHP 5.3
Description: &quot;PHP is a general-purpose server-side scripting language...&quot;
Version: '5.3'
Versions: [5.3]
License: &quot;The PHP License, version 3.0&quot;
License-Url: http://www.php.net/license/3_0.txt
Vendor: PHP Group
Categories:
  - service
  - php
  - web_framework
Website: http://www.php.net
Help-Topics:
  &quot;Developer Center&quot;: https://openshift.redhat.com/community/developers
Cart-Data:
  - Key: OPENSHIFT_...
    Type: environment
    Description: &quot;How environment variable should be used&quot;
Provides:
  - php-5.3
  - &quot;php&quot;
  - &quot;php(version) = 5.3.2&quot;
Publishes:
  get-php-ini:
    Type: &quot;FILESYSTEM:php-ini&quot;
  publish-http-url:
    Type: &quot;NET_TCP:httpd-proxy-info&quot;
  publish-gear-endpoint:
    Type: &quot;NET_TCP:gear-endpoint-info&quot;
Subscribes:
  set-db-connection-info:
    Type: &quot;NET_TCP:db:connection-info&quot;
    Required: false
  set-nosql-db-connection-info:
    Type: &quot;NET_TCP:nosqldb:connection-info&quot;
    Required: false
  set-mysql-connection-info:
    Type: &quot;NET_TCP:db:mysql&quot;
    Required : false
  set-postgres-connection-info:
    Type: &quot;NET_TCP:db:postgres&quot;
    Required : false
  set-doc-url:
    Type: &quot;STRING:urlpath&quot;
    Required : false
Scaling:
  Min: 1
  Max: -1
Group-Overrides:
  - components:
    - php-5.3
    - web_proxy
Endpoints:
  - Private-IP-Name:   IP1
    Private-Port-Name: HTTP_PORT
    Private-Port:      8080
    Public-Port-Name:  PROXY_HTTP_PORT
    Mappings:
      - Frontend:      &quot;/front&quot;
        Backend:       &quot;/back&quot;
        Options:       { websocket: true }
</code></pre>

<p>Additional-Control-Actions:
  - threaddump</p>

<h3>Cartridge-Short-Name Element</h3>

<p>OpenShift creates a number of environment variables for you, when installing your cartridge.
This shorten name is used when creating those variables.
For example, using the example manifest the following environment variables would be created:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_OPENSHIFT_PHP_DIR constant id'>OPENSHIFT_PHP_DIR</span>
<span class='rubyid_OPENSHIFT_PHP_IP constant id'>OPENSHIFT_PHP_IP</span>
<span class='rubyid_OPENSHIFT_PHP_PORT constant id'>OPENSHIFT_PHP_PORT</span>
<span class='rubyid_OPENSHIFT_PHP_PROXY_PORT constant id'>OPENSHIFT_PHP_PROXY_PORT</span>
</code></pre>

<h3>Cartridge-Version Element</h3>

<p>The <code>Cartridge-Version</code> element is a version number identifying a release of your cartridge to OpenShift.
The value follows the format:</p>

<pre class="code ruby"><code class="ruby"><span class='lt op'>&lt;</span><span class='rubyid_number identifier id'>number</span><span class='gt op'>&gt;</span><span class='lbrack token'>[</span><span class='dot token'>.</span><span class='lt op'>&lt;</span><span class='rubyid_number identifier id'>number</span><span class='gt op'>&gt;</span><span class='lbrack token'>[</span><span class='dot token'>.</span><span class='lt op'>&lt;</span><span class='rubyid_number identifier id'>number</span><span class='gt op'>&gt;</span><span class='lbrack token'>[</span><span class='dot3 op'>...</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span><span class='rbrack token'>]</span>
</code></pre>

<p>When you publish new versions of your cartridge to OpenShift, this number will be used to determine what
is necessary to upgrade the application developer&#39;s application. YAML will assume number.number is a float
be sure to enclose it in quotes so it is read as a string.</p>

<h3>Cartridge-Versions Element</h3>

<p><code>Cartridge-Versions</code> is a list of past cartridge versions that are <strong>compatible</strong> with this version.
To be <strong>compatible</strong> with a previous version, the code changes you made in this version do not require
the cartridge to be re-started or the application developer&#39;s application to be restarted.</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_Cartridge constant id'>Cartridge</span><span class='minus op'>-</span><span class='rubyid_Versions constant id'>Versions</span><span class='colon op'>:</span> <span class='lbrack token'>[</span><span class='float val'>1.0</span><span class='integer val'>.1</span><span class='rbrack token'>]</span>
</code></pre>

<p>By not requiring a restart, you improve the application user&#39;s experience since no downtime will
be incurred from your changes. If the cartridge&#39;s current version is not in the list when upgraded,
the cartridge will be stopped, the new code will be installed, <code>setup</code> will be run, and the cartridge
started.</p>

<p>Today this is a simple list and string matching is used to determine compatible versions.
If this list proves to be unmanageable, future versions of OpenShift may implement maven dependency range style checking.</p>

<h3>Cartridge-Vendor</h3>

<p>The <code>Cartridge-Vendor</code> element is used to differentiate cartridges when installed in the system.
As an individual you should use the same unique value for all your cartridges to identify yourself,
otherwise use your company name.</p>

<h3>Version Element</h3>

<p>The <code>Version</code> element is the default or only version of the software packaged by this cartridge.</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_Version constant id'>Version</span><span class='colon op'>:</span> <span class='string val'>'5.3'</span>
</code></pre>

<h3>Versions Element</h3>

<p><code>Versions</code> is the list of the versions of the software packaged by this cartridge.</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_Versions constant id'>Versions</span><span class='colon op'>:</span> <span class='lbrack token'>[</span><span class='float val'>5.3</span><span class='rbrack token'>]</span>
</code></pre>

<h3>Additional-Control-Actions Element</h3>

<p>The <code>Additional-Control-Actions</code> element is a list of optional actions supported by your cartridge.  <code>threaddump</code> is an example of
one such action. OpenShift will only call optional actions if they are included in this element.
Supported optional actions:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_threaddump identifier id'>threaddump</span>
</code></pre>

<h3>Endpoints Element</h3>

<p>See below.</p>

<h2>Cartridge Locking</h2>

<p>Cartridge instances within a gear will be either <code>locked</code> or <code>unlocked</code>
at any given time. Locking a cartridge allows the cartridge scripts
to have additional access to the gear&#39;s files and directories. Other
scripts and hooks written by the application developer will not be able to
override decisions you make as the cartridge author.</p>

<p>The lock state is controlled by OpenShift. Cartridges are locked and
unlocked at various points in the cartridge lifecycle.</p>

<p>If you fail to provide a <code>metadata/locked_files.txt</code> file or the file
is empty, your cartridge will remain always unlocked. For a very simple cartridges
this may be sufficient.</p>

<p><strong>Note on security:</strong> Cartridge file locking is not intended to be a
security measure. It is a mechanism to help prevent application developers
from inadvertently breaking their application by modifying files reserved
for use by you, the cartridge author.</p>

<h3>Lock configuration</h3>

<p>The <code>metadata/locked_files.txt</code> lists the files and directories, one
per line, that will be provided to the cartridge author with read/write
access while the cartridge is unlocked, but only read access to the
application developer while the cartridge is locked.</p>

<p>Any non-existent files that are included in the list will be created
before your <code>setup</code> script is called.  Any missing parent directories will be
created as needed. The list is anchored at the cartridge&#39;s directory.
An entry ending in slash is processed as a directory.  Entries ending
in asterisk are a list of files.  Entries ending in an other character
are considered files.  OpenShift will not attempt to change files to
directories or vice versa, and your cartridge may fail to operate if
files are miscatergorized and you depend on OpenShift to create them.</p>

<p>Any lines starting with <code>~/</code> will be anchored at the gear directory rather
than the cartridge directory.</p>

<h4>Lock configuration example</h4>

<p>Here is a <code>locked_files.txt</code> for a PHP cartridge:</p>

<pre class="code ruby"><code class="ruby"><span class='bitnot op'>~</span><span class='regexp val'>/.pearrc
bin/</span>
<span class='rubyid_conf identifier id'>conf</span><span class='div op'>/</span><span class='mult op'>*</span>
</code></pre>

<p>In the above list:
  * the file <code>~/.pearrc</code> will be created, if it does not exists, and be made editable by you.
  * the directory <code>php/bin</code> is locked but not the files it contains. While you can add files, both you
    and the application developer can edit any files contained.
  * the files in <code>php/conf</code> are locked but the directory itself is not.
    So you or the application developer can add files, but only you can edit them.</p>

<p>Directories like <code>~/.node-gyp</code> and <code>~/.npm</code> in nodejs are <strong>NOT</strong> candidates
to be created in this manner as they require the application developer to have read
and write access while the application is deploying and running. These
directories would need to be created by the nodejs <code>setup</code> script.</p>

<p>The following list is reserved by OpenShift in the the gear&#39;s home
directory:</p>

<pre class="code ruby"><code class="ruby"><span class='bitnot op'>~</span><span class='regexp val'>/.ssh
~/</span><span class='dot token'>.</span><span class='rubyid_sandbox identifier id'>sandbox</span>
<span class='bitnot op'>~</span><span class='regexp val'>/.tmp
~/</span><span class='dot token'>.</span><span class='rubyid_env identifier id'>env</span>
<span class='rubyid_any identifier id'>any</span> <span class='rubyid_not not kw'>not</span> <span class='rubyid_hidden identifier id'>hidden</span> <span class='rubyid_directory identifier id'>directory</span> <span class='rubyid_or or kw'>or</span> <span class='rubyid_file identifier id'>file</span>
</code></pre>

<p>You may create any hidden file or directory (one that starts with a
period) not in the reserved list in the gear&#39;s home directory while the
cartridge is unlocked.</p>

<h2>template vs template.git (for language cartridges)</h2>

<p><code>template</code> or <code>template.git</code> directory should provide an minimal example of an application
written in the language/framework your cartridge is packaging.
Your application should welcome the application developer to
your cartridge and let them see that your cartridge has indeed been installed and operating.
If you provide a <code>template</code> directory, OpenShift will transform it into a bare git repository
for use by the application developer. If you provide a <code>template.git</code> directory, OpenShift will
copy the directory for use by the application developer. Your <code>setup</code> script should assume that
<code>template</code> directories may be converted to <code>template.git</code> during the packaging of your cartridge
for use by OpenShift. The PaaS operator may choose to convert all <code>template</code> directories to bare
git repositories <code>template.git</code> to obtain the performance gain when adding your cartridge to gear.
One good workflow point to make this change is when your cartridge is packaged into an RPM.</p>

<p>A <code>ruby 1.8</code> with <code>Passenger</code> support would have a <code>public</code> sub-directory and
a <code>config.ru</code> file to define the web application.</p>

<pre class="code ruby"><code class="ruby"><span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_template identifier id'>template</span>
<span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_config identifier id'>config</span><span class='dot token'>.</span><span class='rubyid_ru identifier id'>ru</span>
<span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_public identifier id'>public</span>
<span class='bitor op'>|</span>  <span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='dot token'>.</span><span class='rubyid_gitignore identifier id'>gitignore</span>
<span class='bitor op'>|</span>  <span class='dot token'>.</span><span class='rubyid_openshift identifier id'>openshift</span>
<span class='bitor op'>|</span>  <span class='plus op'>+</span><span class='minus op'>-</span> <span class='rubyid_markers identifier id'>markers</span>
<span class='bitor op'>|</span>  <span class='bitor op'>|</span><span class='minus op'>-</span> <span class='dot3 op'>...</span>
</code></pre>

<p>Note that .gitignore should be placed in empty directories to ensure they survive when the file tree
is loaded into a git repository.</p>

<h3>Application Developer Action Hooks</h3>

<p>The sub-directory <code>.openshift/markers</code> may contain example files for the application developer.
These files denote behaviour you are expected to honor in your cartridges lifecycle. Current
examples from a Ruby 1.8 cartridge include:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_force_clean_build identifier id'>force_clean_build</span>     <span class='rubyid_Previous constant id'>Previous</span> <span class='rubyid_output identifier id'>output</span> <span class='rubyid_from identifier id'>from</span> <span class='rubyid_bundle identifier id'>bundle</span> <span class='rubyid_install identifier id'>install</span> <span class='minus op'>-</span><span class='minus op'>-</span><span class='rubyid_deployment identifier id'>deployment</span> <span class='rubyid_will identifier id'>will</span> <span class='rubyid_be identifier id'>be</span>
                      <span class='rubyid_removed identifier id'>removed</span> <span class='rubyid_and and kw'>and</span> <span class='rubyid_all identifier id'>all</span> <span class='rubyid_gems identifier id'>gems</span> <span class='rubyid_will identifier id'>will</span> <span class='rubyid_be identifier id'>be</span> <span class='rubyid_reinstalled identifier id'>reinstalled</span> <span class='rubyid_according identifier id'>according</span> <span class='rubyid_to identifier id'>to</span> <span class='rubyid_the identifier id'>the</span>
                      <span class='rubyid_current identifier id'>current</span> <span class='rubyid_Gemfile constant id'>Gemfile</span><span class='div op'>/</span><span class='rubyid_Gemfile constant id'>Gemfile</span><span class='dot token'>.</span><span class='rubyid_lock identifier id'>lock</span><span class='dot token'>.</span>
<span class='rubyid_hot_deploy identifier id'>hot_deploy</span>            <span class='rubyid_Will constant id'>Will</span> <span class='rubyid_prevent identifier id'>prevent</span> <span class='rubyid_the identifier id'>the</span> <span class='rubyid_apache identifier id'>apache</span> <span class='rubyid_process identifier id'>process</span> <span class='rubyid_from identifier id'>from</span> <span class='rubyid_being identifier id'>being</span> <span class='rubyid_restarted identifier id'>restarted</span> <span class='rubyid_during identifier id'>during</span>
                      <span class='rubyid_build identifier id'>build</span><span class='div op'>/</span><span class='rubyid_deployment identifier id'>deployment</span><span class='dot token'>.</span> <span class='rubyid_Note constant id'>Note</span> <span class='rubyid_that identifier id'>that</span> <span class='rubyid_mod_passenger identifier id'>mod_passenger</span> <span class='rubyid_will identifier id'>will</span> <span class='rubyid_respawn identifier id'>respawn</span> <span class='rubyid_the identifier id'>the</span>
                      <span class='rubyid_Rack constant id'>Rack</span> <span class='rubyid_worker identifier id'>worker</span> <span class='rubyid_processes identifier id'>processes</span> <span class='rubyid_if if_mod kw'>if</span> <span class='rubyid_any identifier id'>any</span> <span class='rubyid_code identifier id'>code</span> <span class='rubyid_has identifier id'>has</span> <span class='rubyid_been identifier id'>been</span> <span class='rubyid_modified identifier id'>modified</span><span class='dot token'>.</span>
<span class='rubyid_disable_auto_scaling identifier id'>disable_auto_scaling</span>  <span class='rubyid_Will constant id'>Will</span> <span class='rubyid_prevent identifier id'>prevent</span> <span class='rubyid_scalable identifier id'>scalable</span> <span class='rubyid_applications identifier id'>applications</span> <span class='rubyid_from identifier id'>from</span> <span class='rubyid_scaling identifier id'>scaling</span> <span class='rubyid_up identifier id'>up</span>
                      <span class='rubyid_or or kw'>or</span> <span class='rubyid_down identifier id'>down</span> <span class='rubyid_according identifier id'>according</span> <span class='rubyid_to identifier id'>to</span> <span class='rubyid_application identifier id'>application</span> <span class='rubyid_load identifier id'>load</span><span class='dot token'>.</span>
</code></pre>

<p>You may add additional markers to allow an application developer to control aspects
of your cartridge.</p>

<p>The sub-directory <code>.openshift/action_hooks</code> will contain code the application developer
wishes run during lifecycle changes. Examples would be:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_pre_start_ identifier id'>pre_start_</span><span class='xstring val'>`cartridge name`</span><span class='minus op'>-</span><span class='xstring val'>`software version`</span>
<span class='rubyid_post_start_ identifier id'>post_start_</span><span class='xstring val'>`cartridge name`</span><span class='minus op'>-</span><span class='xstring val'>`software version`</span>
<span class='rubyid_pre_stop_ identifier id'>pre_stop_</span><span class='xstring val'>`cartridge name`</span><span class='minus op'>-</span><span class='xstring val'>`software version`</span>
<span class='dot3 op'>...</span>
</code></pre>

<p>You can obtain a template for the <code>template</code> directory from <a href="http;//git...yyy">xxx</a>.
You will want to down the repo as a zip file and extract the files into your
cartridge&#39;s <code>template</code> directory. Further details are in the README.writing_applications.md
document.</p>

<p>As a cartridge author you do not need to execute the default <code>action_hooks</code>.
OpenShift will call them during lifecycle changes based on the actions given to the
<code>control</code> script. If you wish to add additional hooks, you are expected to document them
and you will need to run them explicitly in your <code>control</code> script.</p>

<h2>Exposing Services / TCP Endpoints</h2>

<p>Most cartridges provide a service by binding to one or many ports. Cartridges
must explicitly declare which ports they will bind to, and provide meaningful
variable names to describe:</p>

<ul>
<li>Any IP addresses necessary for binding</li>
<li>The gear-local ports to which the cartridge services will bind</li>
<li>(Optional) Publicly proxied ports which expose gear-local ports for use by the
application&#39;s users or across application gears</li>
</ul>

<p>In addition to IP and port definitions, Endpoints are where frontend httpd mappings
for your cartridge are declared to route traffic from the outside world to your
cartridge&#39;s services.</p>

<p>These declarations represent &quot;Endpoints,&quot; and are defined in the cartridge
<code>manifest.yml</code> in the <code>Endpoints</code> section using the following format:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_Endpoints constant id'>Endpoints</span><span class='colon op'>:</span>
  <span class='minus op'>-</span> <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_IP constant id'>IP</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>   <span class='lt op'>&lt;</span><span class='rubyid_name identifier id'>name</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_IP constant id'>IP</span> <span class='rubyid_variable identifier id'>variable</span><span class='gt op'>&gt;</span>
    <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span> <span class='lt op'>&lt;</span><span class='rubyid_name identifier id'>name</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_port identifier id'>port</span> <span class='rubyid_variable identifier id'>variable</span><span class='gt op'>&gt;</span>
    <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='colon op'>:</span>      <span class='lt op'>&lt;</span><span class='rubyid_port identifier id'>port</span> <span class='rubyid_number identifier id'>number</span><span class='gt op'>&gt;</span>
    <span class='rubyid_Public constant id'>Public</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>  <span class='lt op'>&lt;</span><span class='rubyid_name identifier id'>name</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_public identifier id'>public</span> <span class='rubyid_port identifier id'>port</span> <span class='rubyid_variable identifier id'>variable</span><span class='gt op'>&gt;</span>
    <span class='rubyid_Mappings constant id'>Mappings</span><span class='colon op'>:</span>
      <span class='minus op'>-</span> <span class='rubyid_Frontend constant id'>Frontend</span><span class='colon op'>:</span>      <span class='string val'>&quot;&lt;frontend path&gt;&quot;</span>
        <span class='rubyid_Backend constant id'>Backend</span><span class='colon op'>:</span>       <span class='string val'>&quot;&lt;backend path&gt;&quot;</span>
        <span class='rubyid_Options constant id'>Options</span><span class='colon op'>:</span>       <span class='lbrace token'>{</span> <span class='dot3 op'>...</span> <span class='rbrace token'>}</span>
      <span class='minus op'>-</span> <span class='lt op'>&lt;</span><span class='dot3 op'>...</span><span class='gt op'>&gt;</span>
  <span class='minus op'>-</span> <span class='lt op'>&lt;</span><span class='dot3 op'>...</span><span class='gt op'>&gt;</span>
</code></pre>

<p>During cartridge installation within a gear, IP addresses will be automatically
allocated and assigned to each distinct IP variable name, with the guarantee
that the specified port will be bindable on the allocated address.</p>

<p>If an endpoint specifies a public port variable, a public port proxy mapping will
be created using a random external port accessible via the gear&#39;s DNS entry.</p>

<p>Each portion of the endpoint definition becomes available via environment variables
located within the gear and accessible to cartridge scripts and application code. The
names of these variables are prefixed with OpenShift namespacing information in the
follow the format:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_OPENSHIFT_ constant id'>OPENSHIFT_</span><span class='lbrace token'>{</span><span class='rubyid_Cartridge constant id'>Cartridge</span><span class='minus op'>-</span><span class='rubyid_Short constant id'>Short</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='rbrace token'>}</span><span class='rubyid__ identifier id'>_</span><span class='lbrace token'>{</span><span class='rubyid_name identifier id'>name</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_IP constant id'>IP</span> <span class='rubyid_variable identifier id'>variable</span><span class='rbrace token'>}</span>          <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_internal identifier id'>internal</span> <span class='rubyid_IP constant id'>IP</span><span class='gt op'>&gt;</span>
<span class='rubyid_OPENSHIFT_ constant id'>OPENSHIFT_</span><span class='lbrace token'>{</span><span class='rubyid_Cartridge constant id'>Cartridge</span><span class='minus op'>-</span><span class='rubyid_Short constant id'>Short</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='rbrace token'>}</span><span class='rubyid__ identifier id'>_</span><span class='lbrace token'>{</span><span class='rubyid_name identifier id'>name</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_port identifier id'>port</span> <span class='rubyid_variable identifier id'>variable</span><span class='rbrace token'>}</span>        <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lt op'>&lt;</span><span class='rubyid_endpoint identifier id'>endpoint</span> <span class='rubyid_specified identifier id'>specified</span> <span class='rubyid_port identifier id'>port</span><span class='gt op'>&gt;</span>
<span class='rubyid_OPENSHIFT_ constant id'>OPENSHIFT_</span><span class='lbrace token'>{</span><span class='rubyid_Cartridge constant id'>Cartridge</span><span class='minus op'>-</span><span class='rubyid_Short constant id'>Short</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='rbrace token'>}</span><span class='rubyid__ identifier id'>_</span><span class='lbrace token'>{</span><span class='rubyid_name identifier id'>name</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_public identifier id'>public</span> <span class='rubyid_port identifier id'>port</span> <span class='rubyid_variable identifier id'>variable</span><span class='rbrace token'>}</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_external identifier id'>external</span> <span class='rubyid_port identifier id'>port</span><span class='gt op'>&gt;</span>
</code></pre>

<p><code>Cartridge-Short-Name</code> is the <code>Cartridge-Short-Name</code> element from the cartridge manifest
file. See above.</p>

<p>If an endpoint specifies a <code>Mappings</code> section, each mapping entry will be used
to create a frontend httpd  route to your cartridge using the provided options.
The <code>Frontend</code> key represents a frontend path element  to be connected to a
backend URI specified by the <code>Backend</code> key. The optional <code>Options</code> hash for a
mapping allows the route to be configured in a variety of ways:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_Options constant id'>Options</span><span class='colon op'>:</span>
  <span class='rubyid_websocket identifier id'>websocket</span>      <span class='rubyid_Enable constant id'>Enable</span> <span class='rubyid_web identifier id'>web</span> <span class='rubyid_sockets identifier id'>sockets</span> <span class='rubyid_on identifier id'>on</span> <span class='rubyid_a identifier id'>a</span> <span class='rubyid_particular identifier id'>particular</span> <span class='rubyid_path identifier id'>path</span>
  <span class='rubyid_gone identifier id'>gone</span>           <span class='rubyid_Mark constant id'>Mark</span> <span class='rubyid_the identifier id'>the</span> <span class='rubyid_path identifier id'>path</span> <span class='rubyid_as identifier id'>as</span> <span class='rubyid_gone identifier id'>gone</span> <span class='lparen token'>(</span><span class='rubyid_uri identifier id'>uri</span> <span class='rubyid_is identifier id'>is</span> <span class='rubyid_ignored identifier id'>ignored</span><span class='rparen token'>)</span>
  <span class='rubyid_forbidden identifier id'>forbidden</span>      <span class='rubyid_Mark constant id'>Mark</span> <span class='rubyid_the identifier id'>the</span> <span class='rubyid_path identifier id'>path</span> <span class='rubyid_as identifier id'>as</span> <span class='rubyid_forbidden identifier id'>forbidden</span> <span class='lparen token'>(</span><span class='rubyid_uri identifier id'>uri</span> <span class='rubyid_is identifier id'>is</span> <span class='rubyid_ignored identifier id'>ignored</span><span class='rparen token'>)</span>
  <span class='rubyid_noproxy identifier id'>noproxy</span>        <span class='rubyid_Mark constant id'>Mark</span> <span class='rubyid_the identifier id'>the</span> <span class='rubyid_path identifier id'>path</span> <span class='rubyid_as identifier id'>as</span> <span class='rubyid_not not kw'>not</span> <span class='rubyid_proxied identifier id'>proxied</span> <span class='lparen token'>(</span><span class='rubyid_uri identifier id'>uri</span> <span class='rubyid_is identifier id'>is</span> <span class='rubyid_ignored identifier id'>ignored</span><span class='rparen token'>)</span>
  <span class='rubyid_redirect identifier id'>redirect</span>       <span class='rubyid_Use constant id'>Use</span> <span class='rubyid_redirection identifier id'>redirection</span> <span class='rubyid_to identifier id'>to</span> <span class='rubyid_uri identifier id'>uri</span> <span class='rubyid_instead identifier id'>instead</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_proxy identifier id'>proxy</span> <span class='lparen token'>(</span><span class='rubyid_uri identifier id'>uri</span> <span class='rubyid_must identifier id'>must</span> <span class='rubyid_be identifier id'>be</span> <span class='rubyid_a identifier id'>a</span> <span class='rubyid_path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='rubyid_file identifier id'>file</span>           <span class='rubyid_Ignore constant id'>Ignore</span> <span class='rubyid_request identifier id'>request</span> <span class='rubyid_and and kw'>and</span> <span class='rubyid_load identifier id'>load</span> <span class='rubyid_file identifier id'>file</span> <span class='rubyid_path identifier id'>path</span> <span class='rubyid_contained identifier id'>contained</span> <span class='rubyid_in in kw'>in</span> <span class='rubyid_uri identifier id'>uri</span> <span class='lparen token'>(</span><span class='rubyid_must identifier id'>must</span> <span class='rubyid_be identifier id'>be</span> <span class='rubyid_path identifier id'>path</span><span class='rparen token'>)</span>
  <span class='rubyid_tohttps identifier id'>tohttps</span>        <span class='rubyid_Redirect constant id'>Redirect</span> <span class='rubyid_request identifier id'>request</span> <span class='rubyid_to identifier id'>to</span> <span class='rubyid_https identifier id'>https</span> <span class='rubyid_and and kw'>and</span> <span class='rubyid_use identifier id'>use</span> <span class='rubyid_the identifier id'>the</span> <span class='rubyid_path identifier id'>path</span> <span class='rubyid_contained identifier id'>contained</span> <span class='rubyid_in in kw'>in</span> <span class='rubyid_the identifier id'>the</span> <span class='rubyid_uri identifier id'>uri</span> <span class='lparen token'>(</span><span class='rubyid_must identifier id'>must</span> <span class='rubyid_be identifier id'>be</span> <span class='rubyid_path identifier id'>path</span><span class='rparen token'>)</span>
</code></pre>

<p>While more than one option is allowed, the above options conflict with each other.</p>

<h3>Endpoint Example</h3>

<p>Given a cartridge named <code>CustomCart</code> and the following entry in <code>manifest.yml</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span> <span class='rubyid_CustomCart constant id'>CustomCart</span>
<span class='rubyid_Cartridge constant id'>Cartridge</span><span class='minus op'>-</span><span class='rubyid_Short constant id'>Short</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span> <span class='rubyid_CUSTOMCART constant id'>CUSTOMCART</span>

<span class='dot3 op'>...</span>

<span class='rubyid_Endpoints constant id'>Endpoints</span><span class='colon op'>:</span>
  <span class='minus op'>-</span> <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_IP constant id'>IP</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>   <span class='rubyid_HTTP_IP constant id'>HTTP_IP</span>
    <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span> <span class='rubyid_WEB_PORT constant id'>WEB_PORT</span>
    <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='colon op'>:</span>      <span class='integer val'>8080</span>
    <span class='rubyid_Public constant id'>Public</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>  <span class='rubyid_WEB_PROXY_PORT constant id'>WEB_PROXY_PORT</span>
    <span class='rubyid_Mappings constant id'>Mappings</span><span class='colon op'>:</span>
      <span class='minus op'>-</span> <span class='rubyid_Frontend constant id'>Frontend</span><span class='colon op'>:</span>      <span class='string val'>&quot;/web_front&quot;</span>
        <span class='rubyid_Backend constant id'>Backend</span><span class='colon op'>:</span>       <span class='string val'>&quot;/web_back&quot;</span>
      <span class='minus op'>-</span> <span class='rubyid_Frontend constant id'>Frontend</span><span class='colon op'>:</span>      <span class='string val'>&quot;/socket_front&quot;</span>
        <span class='rubyid_Backend constant id'>Backend</span><span class='colon op'>:</span>       <span class='string val'>&quot;/socket_back&quot;</span>
        <span class='rubyid_Options constant id'>Options</span><span class='colon op'>:</span>       <span class='lbrace token'>{</span> <span class='string val'>&quot;websocket&quot;</span><span class='colon op'>:</span> <span class='rubyid_true true kw'>true</span> <span class='rbrace token'>}</span>

  <span class='minus op'>-</span> <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_IP constant id'>IP</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>   <span class='rubyid_HTTP_IP constant id'>HTTP_IP</span>
    <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span> <span class='rubyid_ADMIN_PORT constant id'>ADMIN_PORT</span>
    <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='colon op'>:</span>      <span class='integer val'>9000</span>
    <span class='rubyid_Public constant id'>Public</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>  <span class='rubyid_ADMIN_PROXY_PORT constant id'>ADMIN_PROXY_PORT</span>
    <span class='rubyid_Mappings constant id'>Mappings</span><span class='colon op'>:</span>
      <span class='minus op'>-</span> <span class='rubyid_Frontend constant id'>Frontend</span><span class='colon op'>:</span>      <span class='string val'>&quot;/admin_front&quot;</span>
      <span class='minus op'>-</span> <span class='rubyid_Backend constant id'>Backend</span><span class='colon op'>:</span>       <span class='string val'>&quot;/admin_back&quot;</span>

  <span class='minus op'>-</span> <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_IP constant id'>IP</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>   <span class='rubyid_INTERNAL_SERVICE_IP constant id'>INTERNAL_SERVICE_IP</span>
    <span class='rubyid_Private constant id'>Private</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span> <span class='integer val'>5544</span>
    <span class='rubyid_Public constant id'>Public</span><span class='minus op'>-</span><span class='rubyid_Port constant id'>Port</span><span class='minus op'>-</span><span class='rubyid_Name constant id'>Name</span><span class='colon op'>:</span>  <span class='rubyid_INTERNAL_SERVICE_PORT constant id'>INTERNAL_SERVICE_PORT</span>
</code></pre>

<p>The following environment variables will be generated:</p>

<pre class="code ruby"><code class="ruby"><span class='comment val'># Internal IP/port allocations</span>
<span class='rubyid_OPENSHIFT_CUSTOMCART_HTTP_IP constant id'>OPENSHIFT_CUSTOMCART_HTTP_IP</span><span class='assign token'>=</span><span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_internal identifier id'>internal</span> <span class='rubyid_IP constant id'>IP</span> <span class='integer val'>1</span><span class='gt op'>&gt;</span>
<span class='rubyid_OPENSHIFT_CUSTOMCART_WEB_PORT constant id'>OPENSHIFT_CUSTOMCART_WEB_PORT</span><span class='assign token'>=</span><span class='integer val'>8080</span>
<span class='rubyid_OPENSHIFT_CUSTOMCART_ADMIN_PORT constant id'>OPENSHIFT_CUSTOMCART_ADMIN_PORT</span><span class='assign token'>=</span><span class='integer val'>9000</span>
<span class='rubyid_OPENSHIFT_CUSTOMCART_INTERNAL_SERVICE_IP constant id'>OPENSHIFT_CUSTOMCART_INTERNAL_SERVICE_IP</span><span class='assign token'>=</span><span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_internal identifier id'>internal</span> <span class='rubyid_IP constant id'>IP</span> <span class='integer val'>2</span><span class='gt op'>&gt;</span>
<span class='rubyid_OPENSHIFT_CUSTOMCART_INTERNAL_SERVICE_PORT constant id'>OPENSHIFT_CUSTOMCART_INTERNAL_SERVICE_PORT</span><span class='assign token'>=</span><span class='integer val'>5544</span>

<span class='comment val'># Public proxy port mappings</span>
<span class='rubyid_OPENSHIFT_CUSTOMCART_WEB_PROXY_PORT constant id'>OPENSHIFT_CUSTOMCART_WEB_PROXY_PORT</span><span class='assign token'>=</span><span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_public identifier id'>public</span> <span class='rubyid_port identifier id'>port</span> <span class='integer val'>1</span><span class='gt op'>&gt;</span>
<span class='rubyid_OPENSHIFT_CUSTOMCART_ADMIN_PROXY_PORT constant id'>OPENSHIFT_CUSTOMCART_ADMIN_PROXY_PORT</span><span class='assign token'>=</span><span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_public identifier id'>public</span> <span class='rubyid_port identifier id'>port</span> <span class='integer val'>2</span><span class='gt op'>&gt;</span>
</code></pre>

<p>In the above example, the public proxy port mappings are as follows:</p>

<pre class="code ruby"><code class="ruby"><span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_external identifier id'>external</span> <span class='rubyid_IP constant id'>IP</span><span class='gt op'>&gt;</span><span class='symbol val'>:&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_public identifier id'>public</span> <span class='rubyid_port identifier id'>port</span> <span class='integer val'>1</span><span class='gt op'>&gt;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_OPENSHIFT_CUSTOMCART_HTTP_IP constant id'>OPENSHIFT_CUSTOMCART_HTTP_IP</span><span class='symbol val'>:OPENSHIFT_CUSTOMCART_WEB_PORT</span>
<span class='lt op'>&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_external identifier id'>external</span> <span class='rubyid_IP constant id'>IP</span><span class='gt op'>&gt;</span><span class='symbol val'>:&lt;</span><span class='rubyid_assigned identifier id'>assigned</span> <span class='rubyid_public identifier id'>public</span> <span class='rubyid_port identifier id'>port</span> <span class='integer val'>2</span><span class='gt op'>&gt;</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_OPENSHIFT_CUSTOMCART_HTTP_IP constant id'>OPENSHIFT_CUSTOMCART_HTTP_IP</span><span class='symbol val'>:OPENSHIFT_CUSTOMCART_ADMIN_PORT</span>
</code></pre>

<p>And finally, the following frontend httpd routes will be created:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/&lt;app dns&gt;/</span><span class='rubyid_web_front identifier id'>web_front</span>    <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/OPENSHIFT_CUSTOMCART_HTTP_IP:8080/</span><span class='rubyid_web_back identifier id'>web_back</span>
<span class='rubyid_http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/&lt;app dns&gt;/s</span><span class='rubyid_ocket_front identifier id'>ocket_front</span> <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/OPENSHIFT_CUSTOMCART_HTTP_IP:8080/s</span><span class='rubyid_ocket_back identifier id'>ocket_back</span>
<span class='rubyid_http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/&lt;app dns&gt;/</span><span class='rubyid_admin_front identifier id'>admin_front</span>  <span class='assign token'>=</span><span class='gt op'>&gt;</span> <span class='rubyid_http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/OPENSHIFT_CUSTOMCART_HTTP_IP:9000/</span><span class='rubyid_admin_back identifier id'>admin_back</span>
</code></pre>

<h2>Cartridge Scripts</h2>

<p>How you implement the cartridge scripts in the <code>bin</code> directory is
up to you as the author. For easily configured software where your
cartridge is just installing one version, these scripts may include all
the necessary code. For complex configurations or multi-version support,
you may choose to write these scripts as shim code to setup the necessary
environment before calling additional scripts you write. Or, you may
choose to create symlinks from these names to a name of your choosing.
Your API is the scripts and their associated actions. The scripts will
be run from the home directory of the gear.</p>

<p>A cartridge must implement the following scripts:</p>

<ul>
<li><code>setup</code>: prepare this instance of cartridge to be operational</li>
<li><code>control</code>: command cartridge to report or change state</li>
</ul>

<p>A cartridge may implement the following scripts:
* <code>teardown</code>: prepare this instance of cartridge to be removed</p>

<h3>Exit Status Codes</h3>

<p>OpenShift follows the convention that your scripts should return zero
for success, and non-zero success. Additionally, OpenShift follows the
conventions from sysexit.h below:</p>

<pre class="code ruby"><code class="ruby">    <span class='integer val'>0</span><span class='dot token'>.</span> <span class='rubyid_Success constant id'>Success</span>
   <span class='float val'>64</span><span class='dot token'>.</span> <span class='rubyid_Usage constant id'>Usage</span><span class='colon op'>:</span> <span class='rubyid_The constant id'>The</span> <span class='rubyid_command identifier id'>command</span> <span class='rubyid_was identifier id'>was</span> <span class='rubyid_used identifier id'>used</span> <span class='rubyid_incorrectly identifier id'>incorrectly</span><span class='comma token'>,</span> <span class='rubyid_e identifier id'>e</span><span class='dot token'>.</span><span class='rubyid_g identifier id'>g</span><span class='dot token'>.</span><span class='comma token'>,</span> <span class='rubyid_with identifier id'>with</span> <span class='rubyid_the identifier id'>the</span> <span class='rubyid_wrong identifier id'>wrong</span> <span class='rubyid_number identifier id'>number</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_arguments identifier id'>arguments</span><span class='comma token'>,</span> <span class='rubyid_a identifier id'>a</span> <span class='rubyid_bad identifier id'>bad</span> <span class='rubyid_flag identifier id'>flag</span><span class='comma token'>,</span> <span class='rubyid_a identifier id'>a</span> <span class='rubyid_bad identifier id'>bad</span> <span class='rubyid_syntax identifier id'>syntax</span> <span class='rubyid_in in kw'>in</span> <span class='rubyid_a identifier id'>a</span> <span class='rubyid_parameter identifier id'>parameter</span><span class='comma token'>,</span> <span class='rubyid_or or kw'>or</span> <span class='rubyid_whatever identifier id'>whatever</span><span class='dot token'>.</span>
   <span class='float val'>65</span><span class='dot token'>.</span> <span class='rubyid_Data constant id'>Data</span> <span class='rubyid_Error constant id'>Error</span><span class='colon op'>:</span> <span class='rubyid_The constant id'>The</span> <span class='rubyid_input identifier id'>input</span> <span class='rubyid_data identifier id'>data</span> <span class='rubyid_was identifier id'>was</span> <span class='rubyid_incorrect identifier id'>incorrect</span> <span class='rubyid_in in kw'>in</span> <span class='rubyid_some identifier id'>some</span> <span class='rubyid_way identifier id'>way</span><span class='dot token'>.</span>  <span class='rubyid_This constant id'>This</span> <span class='rubyid_should identifier id'>should</span> <span class='rubyid_only identifier id'>only</span> <span class='rubyid_be identifier id'>be</span> <span class='rubyid_used identifier id'>used</span> <span class='rubyid_for for kw'>for</span> <span class='rubyid_user identifier id'>user</span><span class='string val'>'s data and not system files.
   66. No Input: An input file (not a system file) did not exist or was not readable.  This could also include errors like &quot;No message&quot; to a mailer.
   67. No User: The user specified did not exist.  This might be used for mail addresses or remote logins.
   68. No Host: The host specified did not exist.  This is used in mail addresses or network requests.
   69. A service is unavailable.  This can occur if a support program or file does not exist.
       This can also be used as a catchall message when something you wanted to do doesn'</span><span class='rubyid_t identifier id'>t</span> <span class='rubyid_work identifier id'>work</span><span class='comma token'>,</span> <span class='rubyid_but identifier id'>but</span> <span class='rubyid_you identifier id'>you</span> <span class='rubyid_don identifier id'>don</span><span class='string val'>'t know why.
   70. Software Error: An internal software error has been detected.  This should be limited to non-operating system related errors as possible.
   71. OS Error: An operating system error has been detected.  This is intended to be used for such things as &quot;cannot fork&quot;,
       &quot;cannot create pipe&quot;, or the like.  It includes things like getuid returning a user that does not exist in the passwd file.
   72. OS File: Some system file (e.g., /etc/passwd, /etc/utmp, etc.) does not exist, cannot be opened, or has some sort of error (e.g., syntax error).
   73. Cannot Create: A (user specified) output file cannot be created.
   74. IO Error: An error occurred while doing I/O on some file.
   75. Temporary Failure: Failure is something that is not really an error.  In sendmail, this means that a mailer (e.g.) could not create a connection,
        and the request should be reattempted later.
   76. Protocol: the remote system returned something that was &quot;not possible&quot; during a protocol exchange.
   77. No Permission: You did not have sufficient permission to perform the operation.  This is not intended for file system problems,
       which should use NOINPUT or CANTCREAT, but rather for higher level permissions.
   78. Configuration Error: A fatal configuration problem was found, but this does not necessarily mean that
       the problem was found while reading the configuration file.
   80-128. reserved for OpenShift usage
   128 + n. Where N is the signal that killed your script

Copyright (c) 1987, 1993 The Regents of the University of California.  All rights reserved.
</span></code></pre>

<p>These exit status codes will allow OpenShift to refine it&#39;s behavior
when returning HTTP status codes for the REST API, whether an internal
operation can continue or should aborted etc. Should your script return
a value not included in this table, OpenShift will assume the problem
is fatal to your cartridge.</p>

<h2>bin/setup</h2>

<h5>Synopsis</h5>

<p><code>setup [--version &lt;version&gt;]</code></p>

<h5>Options</h5>

<ul>
<li><code>--version &lt;version&gt;</code>: Selects which version of cartridge to install. If no version is provided,
the version denoted by the <code>Version</code> element from <code>manifest.yml</code> will be installed.</li>
</ul>

<h5>Description</h5>

<p>The <code>setup</code> script is responsible for creating and/or configuring the
files that were copied from the cartridge repository into the gear&#39;s
directory.</p>

<p>If you have used ERB templates for software configuration those files will be
processed for environment variable substitution after <code>setup</code> is run.  An
example would be PHP&#39;s php.ini file:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_upload_tmp_dir identifier id'>upload_tmp_dir</span> <span class='assign token'>=</span> <span class='string val'>&quot;&lt;%= ENV['OPENSHIFT_HOMEDIR'] %&gt;php-5.3/tmp/&quot;</span>
<span class='rubyid_session identifier id'>session</span><span class='dot token'>.</span><span class='rubyid_save_path identifier id'>save_path</span> <span class='assign token'>=</span> <span class='string val'>&quot;&lt;%= ENV['OPENSHIFT_HOMEDIR'] %&gt;php-5.3/sessions/&quot;</span>
</code></pre>

<p>Other candidates for templates are httpd configuration files for
<code>includes</code>, configuring database to store persistent data in the
OPENSHIFT_DATA_DIR, and setting the application name in the pom.xml file.</p>

<p><code>setup</code> may substitute a version dependent of the <code>template</code> or <code>template.git</code> directories.</p>

<p>Lock context: <code>unlocked</code></p>

<h5>Messaging to OpenShift from cartridge</h5>

<p>Your cartridge may provide a service or services that is consumed by
multiple gears in one application. OpenShift provides the orchestration
necessary for you to publish this service or services. Each message is
written to stdout, one message per line.</p>

<ul>
<li><code>ENV_VAR_ADD: &lt;variable name&gt;=&lt;value&gt;</code></li>
<li><code>CART_DATA: &lt;variable name&gt;=&lt;value&gt;</code></li>
<li><code>CART_PROPERTIES: &lt;key&gt;=&lt;value&gt;</code></li>
<li><code>APP_INFO: &lt;value&gt;</code></li>
</ul>

<p><em>jwh: need to explain when/where to use each...  May need to change format to match Lock context</em>
<em>jwh: See Krishna when he is back in town. He wished to make changes in this area with the model refactor.</em></p>

<h2>Custom HTTP Services</h2>

<p>Your cartridge may expose services using the application&#39;s URL by
providing snippet(s) of Apache configuration code using ERB templates
in the httpd.d directory. The httpd.d directory and it&#39;s contents are
optional.  After OpenShift has run your <code>setup</code> script it will render
each ERB template, and write the contents the node&#39;s httpd configuration.</p>

<p>An example of <code>mongodb-2.2.conf.erb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_Alias constant id'>Alias</span> <span class='regexp val'>/health &lt;%= ENV['OPENSHIFT_HOMEDIR'] + &quot;/</span><span class='rubyid_mongodb identifier id'>mongodb</span><span class='minus op'>-</span><span class='float val'>2.2</span><span class='div op'>/</span><span class='rubyid_httpd identifier id'>httpd</span><span class='dot token'>.</span><span class='rubyid_d identifier id'>d</span><span class='div op'>/</span><span class='rubyid_health identifier id'>health</span><span class='dot token'>.</span><span class='rubyid_html identifier id'>html</span><span class='string val'>&quot; %&gt;
Alias / &lt;%= ENV['OPENSHIFT_HOMEDIR'] + &quot;</span><span class='div op'>/</span><span class='rubyid_mongodb identifier id'>mongodb</span><span class='minus op'>-</span><span class='float val'>2.2</span><span class='div op'>/</span><span class='rubyid_httpd identifier id'>httpd</span><span class='dot token'>.</span><span class='rubyid_d identifier id'>d</span><span class='div op'>/</span><span class='rubyid_index identifier id'>index</span><span class='dot token'>.</span><span class='rubyid_html identifier id'>html</span><span class='string val'>&quot; %&gt;
</span></code></pre>

<p>Your templates will be rendered at <code>safe_level 2</code>.  <a href="http://www.ruby-doc.org/docs/ProgrammingRuby/html/taint.html">Locking Ruby in
the Safe</a>.</p>

<h2>bin/teardown</h2>

<h5>Synopsis</h5>

<p><code>teardown</code></p>

<h5>Description</h5>

<p>The <code>teardown</code> script prepares the gear for the cartridge to be
removed. This script will not called when the gear is destroyed.  The <code>teardown</code>
script is only run when a cartridge is to be removed from the gear.
The gear is expected to continue to operate minus the functionality of your cartridge
cartridge.</p>

<p>Lock context: <code>unlocked</code></p>

<p><em>jwh: If all future gears are scaled, should teardown just always be called?</em></p>

<h5>Messaging to OpenShift from cartridge</h5>

<p>After <code>teardown</code> your cartridge&#39;s services are no longer available. For
each environment variable you published, you must now un-publish it by
writing to stdout the following message(s):</p>

<ul>
<li><code>ENV_VAR_REMOVE: &lt;name&gt;</code></li>
</ul>

<p><em>jwh: See Krishna when he is back in town. He wished to make changes in this area with the model refactor.</em></p>

<h2>bin/control</h2>

<h5>Synopsis</h5>

<p><code>control &lt;action&gt;</code></p>

<h5>Options</h5>

<ul>
<li><code>action</code>: which operation the cartridge should perform.</li>
</ul>

<h5>Description</h5>

<p>The <code>control</code> script allows OpenShift or user to control the state of the cartridge.</p>

<p>The list of operations your cartridge may be called to perform:</p>

<ul>
<li><code>pre-build</code>, <code>build</code>, <code>deploy</code>, and <code>post-deploy</code> are called at various
 points during the build lifecycle, described in the <a href="#openshift-builds">OpenShift Builds</a> section.</li>
<li><code>start</code> start the software your cartridge controls</li>
<li><code>stop</code> stop the software your cartridge controls</li>
<li><code>status</code> return an 0 exit status if your cartridge code is running.</li>
<li><code>reload</code> your cartridge and the packaged software needs to re-read their
  configuration information. This operation will only be called if your cartridge is
  running.</li>
<li><code>restart</code> stop current process and start a new one for the code your cartridge packages</li>
<li><code>threaddump</code> if applicable, your cartridge should signal the packaged software to perform a thread dump.</li>
<li><code>tidy</code> all unused resources should be released. It is at your discretion to
 determine what should be done. Be frugal, on some systems resources may be
 very limited. Some possible behaviors: 

<ul>
<li><code>rm $OPENSHIFT_CART_DIR/logs/log.[0-9]</code></li>
<li><code>cd $OPENSHIFT_REPO_DIR ; mvn clean</code></li>
</ul></li>
<li><code>pre-snapshot</code> prepare the cartridge for snapshot</li>
<li><code>post-snapshot</code> clean up the cartridge after snapshot</li>
<li><code>pre-restore</code> prepare the cartridge for restore</li>
<li><p><code>post-restore</code> clean up the cartridge after being restored</p>

<p>OpenShift has the following default behaviors:</p>

<ul>
<li>the Git repository will be garbage collected</li>
<li>all files will be removed from the <code>/tmp</code> directory</li>
</ul></li>
</ul>

<p>Lock context: <code>locked</code></p>

<h6><code>status</code> Action</h6>

<p>For a number of reasons the application developer will want to be a
to query whether the software your cartridge packages is running and
behaving as expected.  A <code>0</code> exit status implies that the software is
running correctly. </p>

<p>You may direct information to the application developer by writing
to stdout.  Errors may be return on stderr with an non-zero exit status.</p>

<p>OpenShift maintains the expected state of the gear/application in
<code>~/app-root/runtime/.state</code>. You may not use this to determine the
status of the software you are packaging.  That software may have
crashed so you would be returning invalid status if you used this file&#39;s
value. Future versions of OpenShift may combine the results from the
<code>status</code> action and the value of the <code>.state</code> file to automatically
restart failed applications. For completeness, <code>.state</code> values:</p>

<pre class="code ruby"><code class="ruby"><span class='mult op'>*</span> <span class='xstring val'>`building`</span>    <span class='rubyid_application identifier id'>application</span> <span class='rubyid_is identifier id'>is</span> <span class='rubyid_currently identifier id'>currently</span> <span class='rubyid_being identifier id'>being</span> <span class='rubyid_built identifier id'>built</span>
<span class='mult op'>*</span> <span class='xstring val'>`deploying`</span>   <span class='rubyid_application identifier id'>application</span> <span class='rubyid_is identifier id'>is</span> <span class='rubyid_currently identifier id'>currently</span> <span class='rubyid_being identifier id'>being</span> <span class='rubyid_deployed identifier id'>deployed</span>
<span class='mult op'>*</span> <span class='xstring val'>`idle`</span>        <span class='rubyid_application identifier id'>application</span> <span class='rubyid_has identifier id'>has</span> <span class='rubyid_been identifier id'>been</span> <span class='rubyid_shutdown identifier id'>shutdown</span> <span class='rubyid_because identifier id'>because</span> <span class='rubyid_of identifier id'>of</span> <span class='rubyid_no identifier id'>no</span> <span class='rubyid_activity identifier id'>activity</span>
<span class='mult op'>*</span> <span class='xstring val'>`new`</span>         <span class='rubyid_gear identifier id'>gear</span> <span class='rubyid_has identifier id'>has</span> <span class='rubyid_been identifier id'>been</span> <span class='rubyid_created identifier id'>created</span><span class='comma token'>,</span> <span class='rubyid_but identifier id'>but</span> <span class='rubyid_no identifier id'>no</span> <span class='rubyid_application identifier id'>application</span> <span class='rubyid_has identifier id'>has</span> <span class='rubyid_been identifier id'>been</span> <span class='rubyid_installed identifier id'>installed</span>
<span class='mult op'>*</span> <span class='xstring val'>`started`</span>     <span class='rubyid_application identifier id'>application</span> <span class='rubyid_has identifier id'>has</span> <span class='rubyid_been identifier id'>been</span> <span class='rubyid_commanded identifier id'>commanded</span> <span class='rubyid_to identifier id'>to</span> <span class='rubyid_start identifier id'>start</span>
<span class='mult op'>*</span> <span class='xstring val'>`stopped`</span>     <span class='rubyid_application identifier id'>application</span> <span class='rubyid_has identifier id'>has</span> <span class='rubyid_been identifier id'>been</span> <span class='rubyid_commanded identifier id'>commanded</span> <span class='rubyid_to identifier id'>to</span> <span class='rubyid_stop identifier id'>stop</span>
</code></pre>

<h2>Environment Variables</h2>

<p>Environment variables are use to communicate information between
this cartridge and others, and to OpenShift.  The cartridge controlled
variables are stored in the env directory and will be loaded after
system provided environment variables but before your code is called.
OpenShift provided environment variables will be loaded and available
to be used for all cartridge entry points.</p>

<h3>System Provided Variables (Read Only)</h3>

<ul>
<li><code>HOME</code>                alias for <code>OPENSHIFT_HOMEDIR</code></li>
<li><code>HISTFILE</code>            bash history file</li>
<li><code>OPENSHIFT_APP_DNS</code>   the application&#39;s fully qualified domain name that your cartridge is a part of</li>
<li><code>OPENSHIFT_APP_NAME</code>  the validated user assigned name for the application. Black list is system dependent.</li>
<li><code>OPENSHIFT_APP_UUID</code>  OpenShift assigned UUID for the application</li>
<li><code>OPENSHIFT_DATA_DIR</code>  the directory where your cartridge may store data</li>
<li><code>OPENSHIFT_GEAR_DNS</code>  the gear&#39;s fully qualified domain name that your cartridge is a part of. May or may
                     not be equal to <code>OPENSHIFT_APP_DNS</code></li>
<li><code>OPENSHIFT_GEAR_NAME</code> OpenShift assigned name for the gear. May or may not be equal to <code>OPENSHIFT_APP_NAME</code></li>
<li><code>OPENSHIFT_GEAR_UUID</code> OpenShift assigned UUID for the gear</li>
<li><code>OPENSHIFT_HOMEDIR</code>   OpenShift assigned directory for the gear</li>
<li><code>OPENSHIFT_REPO_DIR</code>  the directory where the developer&#39;s application is &quot;archived&quot; to and will be run from.</li>
<li><code>OPENSHIFT_TMP_DIR</code>   the directory where your cartridge may store temporary data</li>
<li><code>TMPDIR</code>              alias for <code>OPENSHIFT_TMP_DIR</code></li>
<li><code>TMP</code>                 alias for <code>OPENSHIFT_TMP_DIR</code></li>
</ul>

<h3>Examples of Cartridge Variables</h3>

<p>These are variables you either provided to you for communicating to the application developer.  You may add
additional variables for your cartridges or the packaged software needs. You may provide these files in your
cartridge&#39;s <code>env</code> directory or choose to create them in your <code>setup</code> script.</p>

<ul>
<li><code>OPENSHIFT_MYSQL_DB_HOST</code>                  Backwards compatibility (ERB populate from <code>OPENSHIFT_MYSQL_DB_IP</code>)</li>
<li><code>OPENSHIFT_MYSQL_DB_IP</code></li>
<li><code>OPENSHIFT_MYSQL_DB_LOG_DIR</code></li>
<li><code>OPENSHIFT_MYSQL_DB_PASSWORD</code></li>
<li><code>OPENSHIFT_MYSQL_DB_PORT</code></li>
<li><code>OPENSHIFT_MYSQL_DB_SOCKET</code></li>
<li><code>OPENSHIFT_MYSQL_DB_URL</code></li>
<li><code>OPENSHIFT_MYSQL_DB_USERNAME</code></li>
<li><code>OPENSHIFT_PHP_LOG_DIR</code></li>
<li><code>OPENSHIFT_PHP_DIR</code></li>
</ul>

<p>Some variable may be dictated by the software you are packaging:</p>

<ul>
<li><code>JENKINS_URL</code></li>
<li><code>JENKINS_USERNAME</code></li>
<li><code>JENKINS_PASSWORD</code></li>
</ul>

<p>Your environment variables should be prefixed with
<code>OPENSHIFT_{cartridge short name}_</code> to prevent overwriting other cartridge
variables in the packaged software&#39;s process environment space.</p>

<p>By convention, an environment variable whose value is a directory should have a
name that ends in <code>_DIR</code> and the value should have a trailing slash.
The software you are packaging may have environment variable requirements of it&#39;s own,
for example: <code>JENKINS_URL</code>.
Those you would add to your <code>env</code> directory or include in shim code in your <code>bin</code> scripts.</p>

<p>Cartridge provided environment variables are not validated by the
system. Your cartridge may fail to function if you write invalid data
to these files. If you provide ERB templates in the <code>env</code> directory,
OpenShift will render those files and remove the .erb suffix. They will
be processed before your <code>setup</code> script is run. You could write the
<code>env/JENKINS_URL.erb</code> as:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_export identifier id'>export</span> <span class='rubyid_JENKINS_URL constant id'>JENKINS_URL</span><span class='assign token'>=</span><span class='string val'>'https://&lt;%= ENV['</span><span class='rubyid_OPENSHIFT_APP_DNS constant id'>OPENSHIFT_APP_DNS</span><span class='string val'>'] %&gt;/'</span>
</code></pre>

<p>which would then be rendered as <code>env/JENKINS_URL</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_export identifier id'>export</span> <span class='rubyid_JENKINS_URL constant id'>JENKINS_URL</span><span class='assign token'>=</span><span class='string val'>'http://jenkins-namespace.rhcloud.com/'</span>
</code></pre>

<p>Or, <code>env/OPENSHIFT_MONGODB_DB_LOG_DIR.erb</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_export identifier id'>export</span> <span class='rubyid_OPENSHIFT_MONGODB_DB_LOG_DIR constant id'>OPENSHIFT_MONGODB_DB_LOG_DIR</span><span class='assign token'>=</span><span class='string val'>'&lt;% ENV['</span><span class='rubyid_OPENSHIFT_HOMEDIR constant id'>OPENSHIFT_HOMEDIR</span><span class='string val'>'] + &quot;/mongodb-2.2/log/&quot; %&gt;'</span>
</code></pre>

<p>renders as <code>env/OPENSHIFT_MONGODB_DB_LOG_DIR</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_export identifier id'>export</span> <span class='rubyid_OPENSHIFT_MONGODB_DB_LOG_DIR constant id'>OPENSHIFT_MONGODB_DB_LOG_DIR</span><span class='assign token'>=</span><span class='string val'>'/var/lib/openshift/aa9e0f66e6451791f86904eef0939e/mongodb-2.2/log/'</span>
</code></pre>

<p>Your templates will be rendered at <code>safe_level 2</code>.  <a href="http://www.ruby-doc.org/docs/ProgrammingRuby/html/taint.html">Locking Ruby in
the Safe</a>.</p>

<p>You may assume the <code>PATH</code> variable will be:
     PATH=/bin:/usr/bin/</p>

<p>when your code is executed. Any additional directories your code requires
will need to be added in your cartridge&#39;s <code>env</code> variable.</p>

<h2>Backing up and Restoring your cartridge</h2>

<p>OpenShift provides a snapshot/restore feature for user applications.  This feature is meant to allow OpenShift application developers to:</p>

<ol>
<li>Capture the state (&#39;snapshot&#39;) of their application and produce an archive of that state.</li>
<li>Use a previously taken snapshot of an application to restore the application to the state in the snapshot.</li>
<li>Use a previously taken snapshot of an application to restore a new application to the state in the snapshot.  This could be merely renaming an application, or copying an application.</li>
</ol>

<p>OpenShift uses the <code>tar</code> command when backing up and restoring the gear that
contains your cartridge. The file <code>metadata/snapshot_exclusions.txt</code>
contains a pattern per line of files that will not be backed up or
restored. If you exclude files from being backed up and restored you need
to ensure those files are not required for your cartridge&#39;s operation.</p>

<p>The file <code>metadata/restore_transforms.txt</code> contains <code>sed</code> replace
expressions one per line and is used to transform file names during
restore.</p>

<p>Both files are optional and may be omitted. Empty files will be
ignored. Patterns are from the <code>OPENSHIFT_HOMEDIR</code> directory rather
than your cartridge&#39;s directory.  See the man page for <code>tar</code> the <code>--transform</code>
and <code>--exclude-from</code> for more details.</p>

<h3>Understanding OpenShift Behavior: Snapshot</h3>

<p>OpenShift creates an archive during <code>snapshot</code> as follows:</p>

<ol>
<li>OpenShift stops the application by invoking <code>gear stop</code></li>
<li>OpenShift invokes <code>control pre-snapshot</code> for each installed cartridge in the gear.  Cartridges may control their serialization in the snapshot by implementing this control action in conjunction with exclusions. (Example: cartridge authors wants to snapshot/restore to/from a database dump instead of a database file).</li>
<li>OpenShift builds a list of exclusions by reading the <code>snapshot_exclusions.txt</code> file for each cartridge in the gear.</li>
<li>OpenShift creates an archive in tar.gz format and writes it to STDOUT for consumption by the client tools.  The following exclusions are used in addition to the list created from cartridges:

<ol>
<li>Gear user <code>.tmp</code>, <code>.ssh</code>, <code>.sandbox</code></li>
<li>Application state file (<code>app-root/runtime/.state</code>)</li>
<li>Bash history file (<code>$OPENSHIFT_DATA_DIR/.bash_history</code>)</li>
</ol></li>
<li>OpenShift invokes <code>control post-snapshot</code> for each installed cartridge in the gear.</li>
<li>Openshift starts the application by invoking <code>gear start</code></li>
</ol>

<h3>Understanding OpenShift Behavior: Restore</h3>

<p>Openshift restores an application from an archive as follows:</p>

<ol>
<li>OpenShift prepares the application for restoration:

<ol>
<li>If the archive contains a git repo, the platform invokes <code>gear prereceive</code></li>
<li>Otherwise, the platform invokes <code>gear stop</code></li>
</ol></li>
<li>OpenShift invokes <code>control pre-restore</code> for each installed cartridge in the gear.  This allows cartridges that control their snapshotted state to prepare their cartridges for restoration (Example: delete old database dump, if present)</li>
<li>OpenShift builds a list of transforms to apply by reading the <code>restore_transforms.txt</code> file of each cartridge installed in the gear.</li>
<li>OpenShift extracts the archive into the gear user&#39;s home directory, overwriting existing files, and applying the transformations obtained from cartridges.</li>
<li>OpenShift invokes <code>control post-restore</code> for each installed cartridge in the gear.  (Example: delete new database dump that db was restored from). </li>
<li>OpenShift resumes the application:

<ol>
<li>If the archive contains a git repo, OpenShift invokes <code>gear postreceive</code></li>
<li>Otherwise, OpenShift invokes <code>gear start</code> </li>
</ol></li>
</ol>

<h2>Sample <code>conf.d/openshift.conf.erb</code></h2>

<pre class="code ruby"><code class="ruby"><span class='rubyid_ServerRoot constant id'>ServerRoot</span> <span class='string val'>&quot;&lt;%= ENV['OPENSHIFT_HOMEDIR'] + &quot;</span><span class='div op'>/</span><span class='rubyid_ruby identifier id'>ruby</span><span class='minus op'>-</span><span class='float val'>1.8</span><span class='string val'>&quot; %&gt;&quot;</span>
<span class='rubyid_DocumentRoot constant id'>DocumentRoot</span> <span class='string val'>&quot;&lt;%= ENV['OPENSHIFT_REPO_DIR'] + &quot;</span><span class='div op'>/</span><span class='rubyid_public identifier id'>public</span><span class='string val'>&quot; %&gt;&quot;</span>
<span class='rubyid_Listen constant id'>Listen</span> <span class='lt op'>&lt;</span><span class='string val'>%= ENV['OPENSHIFT_RUBY_IP'] + ':' + ENV['OPENSHIFT_RUBY_PORT'] %&gt;
User &lt;%=</span> <span class='rubyid_ENV constant id'>ENV</span><span class='lbrack token'>[</span><span class='string val'>'OPENSHIFT_GEAR_UUID'</span><span class='rbrack token'>]</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span>
<span class='rubyid_Group constant id'>Group</span> <span class='lt op'>&lt;</span><span class='string val'>%= ENV['OPENSHIFT_GEAR_UUID'] %&gt;

ErrorLog &quot;|/usr/sbin/rotatelogs &lt;%=</span> <span class='rubyid_ENV constant id'>ENV</span><span class='lbrack token'>[</span><span class='string val'>'OPENSHIFT_HOMEDIR'</span><span class='rbrack token'>]</span><span class='mod op'>%</span><span class='gt op'>&gt;</span><span class='regexp val'>/ruby-1.8/</span><span class='rubyid_logs identifier id'>logs</span><span class='div op'>/</span><span class='rubyid_error_log identifier id'>error_log</span><span class='minus op'>-</span><span class='rubyid_Y constant id'>Y</span><span class='mod op'>%</span><span class='rubyid_m identifier id'>m</span><span class='mod op'>%</span><span class='rubyid_d identifier id'>d</span><span class='minus op'>-</span><span class='rubyid_H constant id'>H</span><span class='mod op'>%</span><span class='rubyid_M constant id'>M</span><span class='mod op'>%</span><span class='rubyid_S constant id'>S</span><span class='minus op'>-</span><span class='rubyid_Z constant id'>Z</span> <span class='integer val'>86400</span><span class='string val'>&quot;
CustomLog &quot;</span><span class='bitor op'>|</span><span class='regexp val'>/usr/s</span><span class='rubyid_bin identifier id'>bin</span><span class='div op'>/</span><span class='rubyid_rotatelogs identifier id'>rotatelogs</span> <span class='lt op'>&lt;</span><span class='string val'>%= ENV['OPENSHIFT_HOMEDIR']%&gt;/logs/access_log-%Y%m%d-%H%M%S-%Z 86400&quot; combined

PassengerUser &lt;%=</span> <span class='rubyid_ENV constant id'>ENV</span><span class='lbrack token'>[</span><span class='string val'>'OPENSHIFT_GEAR_UUID'</span><span class='rbrack token'>]</span> <span class='mod op'>%</span><span class='gt op'>&gt;</span>
<span class='rubyid_PassengerPreStart constant id'>PassengerPreStart</span> <span class='rubyid_http identifier id'>http</span><span class='symbol val'>:/</span><span class='regexp val'>/&lt;%= ENV['OPENSHIFT_RUBY_IP'] + ':' + ENV['OPENSHIFT_RUBY_PORT'] %&gt;/</span>
<span class='rubyid_PassengerSpawnIPAddress constant id'>PassengerSpawnIPAddress</span> <span class='lt op'>&lt;</span><span class='string val'>%= ENV['OPENSHIFT_RUBY_IP'] %&gt;
PassengerUseGlobalQueue off
&lt;Directory &lt;%=</span> <span class='rubyid_ENV constant id'>ENV</span><span class='lbrack token'>[</span><span class='string val'>'OPENSHIFT_REPO_DIR]%&gt;/public&gt;
  AllowOverride all
  Options -MultiViews
&lt;/Directory&gt;
</span></code></pre>

<h2>Cartridge Events</h2>

<p>Cartridges may need to act when another cartridge is added or removed from an application.
OpenShift supports a simple publish/subscribe system which allows cartridges to communicate
in the context of these events.</p>

<p>The <code>Publishes</code> and <code>Subscribes</code> sections of the cartridge <code>manifest.yml</code> are used to express
the event support for a given cartridge.</p>

<h3>Cartridge Event Publishing</h3>

<p>Publish events are defined via the <code>manifest.yml</code> for the cartridge, in the following format:
<code>
Publishes:
  &lt;event name&gt;:
    Type: &quot;&lt;event type&gt;&quot;
  ...
</code></p>

<p>When a cartridge is added to an application, each entry in the <code>Publishes</code>
section of the manifest is used to construct events dispatched to other cartridges 
in the application. For each publish entry, OpenShift will attempt to execute a
script named <code>hooks/&lt;event name&gt;</code>, e.g.:</p>

<p><code>hooks/&lt;event name&gt; &lt;gear name&gt; &lt;namespace&gt; &lt;gear uuid&gt;</code></p>

<p>All lines of output (on stdout) produced by the script will be joined by single spaces and 
used as the input to matching subscriber scripts. All cartridges which declare a subscription 
whose <code>Type</code> matches that of the publish event will be notified.</p>

<h3>Cartridge Event Subscriptions</h3>

<p>Subscriptions to events published by other carts are defined via the <code>manifest.yml</code> for the
cartridge, in the following format:
<code>
Subscribes:
  &lt;event name&gt;
    Type: &quot;&lt;event type&gt;&quot;
  ...
</code></p>

<p>When a cartridge publish event is fired, the subscription entries in the <code>Subscribes</code>
section whose <code>Type</code> matches that of the publish event will be processed. For each
matching subscription event, OpenShift will attempt to execute a script named
<code>hooks/&lt;event name&gt;</code>, e.g.:</p>

<p><code>hooks/&lt;event name&gt; &lt;gear name&gt; &lt;namespace&gt; &lt;gear uuid&gt; &lt;publish output&gt;</code></p>

<p>The format of the <code>&lt;publish output&gt;</code> input to the subscription script is defined by the 
implementation of the publisher script, and so the cartridge subscription script must have 
an awareness of the output format of the matching publish script.</p>

<h3>Cartridge Event Example</h3>

<p>Consider a simple example of a PHP cartridge which can react when MySQL is added to
an application, so that it can set environment variables on the gear to be able to connect
to the newly added MySQL cartridge on a different gear.</p>

<p>This requires a <code>Subscribes</code> section in the PHP cartridge <code>manifest.yml</code>:
<code>
Subscribes:
  set-mysql-connection-info:
    Type: &quot;NET_TCP:db:mysql&quot;
</code></p>

<p>And a <code>Publishes</code> section in the MySQL cartridge <code>manifest.yml</code>:
<code>
Publishes:
  publish-mysql-connection-info:
    Type: &quot;NET_TCP:db:mysql&quot;
</code></p>

<p>The PHP cartridge implements a script in <code>hooks/set-mysql-connection-info</code>, and the MySQL
cartridge implements a script in <code>hooks/publish-mysql-connection-info</code>.</p>

<p>These events and scripts are matched on the basis of the string value in <code>Type</code> (<code>&quot;NET_TCP:db:mysql&quot;</code>).</p>

<p>The <code>publish-mysql-connection-info</code> script could output the host, port, and password to connect to
the MySQL instance, and it will be fed as input to the <code>set-mysql-connection-info</code> script in the 
PHP cart when MySQL is added to an application that has PHP installed.</p>

<p>For example, the following output from the <code>publish-mysql-connection-info</code> in the MySQL cartridge:</p>

<pre class="code ruby"><code class="ruby"><span class='rubyid_OPENSHIFT_MYSQL_DB_USERNAME constant id'>OPENSHIFT_MYSQL_DB_USERNAME</span><span class='assign token'>=</span><span class='rubyid_username identifier id'>username</span><span class='semicolon token'>;</span>
<span class='rubyid_OPENSHIFT_MYSQL_DB_PASSWORD constant id'>OPENSHIFT_MYSQL_DB_PASSWORD</span><span class='assign token'>=</span><span class='rubyid_password identifier id'>password</span><span class='semicolon token'>;</span>
<span class='rubyid_OPENSHIFT_MYSQL_DB_HOST constant id'>OPENSHIFT_MYSQL_DB_HOST</span><span class='assign token'>=</span><span class='rubyid_hostname identifier id'>hostname</span><span class='semicolon token'>;</span>
<span class='rubyid_OPENSHIFT_MYSQL_DB_PORT constant id'>OPENSHIFT_MYSQL_DB_PORT</span><span class='assign token'>=</span><span class='rubyid_port identifier id'>port</span><span class='semicolon token'>;</span>
<span class='rubyid_OPENSHIFT_MYSQL_DB_URL constant id'>OPENSHIFT_MYSQL_DB_URL</span><span class='assign token'>=</span><span class='rubyid_url identifier id'>url</span><span class='semicolon token'>;</span>
</code></pre>

<p>Would be fed as input to <code>hooks/publish-mysql-connection-info</code> in the PHP cartridge:</p>

<p><code>hooks/publish-mysql-connection-info gear_name namespace gear_uuid &#39;OPENSHIFT_MYSQL_DB_USERNAME=username;OPENSHIFT_MYSQL_DB_PASSWORD=password;OPENSHIFT_MYSQL_DB_HOST=hostname;OPENSHIFT_MYSQL_DB_PORT=port;OPENSHIFT_MYSQL_DB_URL=url;&#39;</code></p>

<p>The <code>publish-mysql-connection-info</code> is responsible for being capable of parsing the final argument
and extracting the values provided.</p>

<h2>OpenShift Builds</h2>

<p>When changes are pushed to an application&#39;s Git repository, OpenShift will build
and deploy the application using the updated changes from the repository. The
specific build lifecycle which manages the build process changes depending on
the presence of a builder cartridge within the application.</p>

<h3>Default Build Lifecycle</h3>

<p>When no builder cartridge has been added to the application, changes pushed to
the application Git repository result in the execution of the default build
lifecycle. The default lifecycle consists of a <code>build</code> and <code>deploy</code> phase, each
of which aggregates several steps.</p>

<p>In this lifecycle, OpenShift manages the start and stop of the application, as
well as moving the newly committed code into <code>$OPENSHIFT_REPO_DIR</code>. All other
specific behaviors are defined by the primary cartridge as well as any user
action hooks present.</p>

<p>Note: User action hooks are assumed to reside in
<code>$OPENSHIFT_REPO_DIR/.openshift/action_hooks</code>.</p>

<p>During the <code>build</code> phase:</p>

<ol>
<li>The application is stopped</li>
<li>The primary cartridge <code>pre-receive</code> control action is executed</li>
<li>The newly committed application source code is copied to <code>$OPENSHIFT_REPO_DIR</code>
<strong>Note</strong>: This step is the only time the application source code is copied by 
OpenShift during this lifecycle.</li>
<li>The primary cartridge <code>pre-build</code> control action is executed (if present)</li>
<li>The <code>pre-build</code> user action hook is executed (if present)</li>
<li>The primary cartridge <code>build</code> control action is executed</li>
<li>The <code>build</code> user action hook is executed</li>
</ol>

<p>Next, during the <code>deploy</code> phase:</p>

<ol>
<li>All secondary cartridges in the application are started</li>
<li>The primary cartridge <code>deploy</code> control action is executed</li>
<li>The <code>deploy</code> user action hook is executed (if present)</li>
<li>The primary cartridge is started (the application is now fully started)</li>
<li>The primary cartridge <code>post-deploy</code> control action is executed</li>
<li>The <code>post-deploy</code> user action hook is executed (if present)</li>
</ol>

<p>At this point, the application has been fully built and restarted.</p>

<h3>Builder Cartridge Lifecycle</h3>

<p>If a builder cartridge is present in the application, changes pushed to the
application Git repository will execute using an alternate build lifecycle which
hands over operations to the builder cartridge. In this lifecycle, OpenShift
provides no specific behavior for the build beyond giving the builder cartridge
the opportunity to perform work. The sequence of events follows:</p>

<p>During the Git <code>pre-receive</code> hook:</p>

<ol>
<li>The builder cartridge <code>pre-receive</code> control action is executed</li>
</ol>

<p>During the Git <code>post-receive</code> hook:</p>

<ol>
<li>The builder cartridge <code>post-receive</code> control action is executed</li>
</ol>

<h3>Builder Tips</h3>

<p>Any build implementation should take care to avoid duplicating source or copying
artifacts any more than necessary. The space a cartridge&#39;s build implementation
consumes during the build cycle is the application developer&#39;s, and so cartridge
authors should take care to be as conservative as possible.</p>
</div></div>

    <div id="footer">
  Generated on Fri Apr 12 19:03:02 2013 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.5.2 (ruby-1.8.7).
</div>

  </body>
</html>